---
title: "Assignment 1"
author: "Junbin Wu"
date: "2024-03-10"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Content

1. Model functions (in chronological order)
  1.1 Simple Linear Model
  1.2 All zeros
  1.3 Decision Tree
  
2. Model Evaluation functions
  2.1 MSE calculation

3. Main functions
  3.1 Library loading
  3.2 Data loading
  3.3 Models Running
  3.4 Model evaluation
  3.5 Output as a CSV

# 1. Model functions (in chronological order)

## 1.1 Simple Linear Model
```{r}
# input a training data set
# output predictions

sim_liner_mod <- function(train) {
  # use `52` as the independent varaible, and `281` as the dependent variable.
  fit <- lm(`281` ~ `7`+`52`+`61`+`62`, data = train)
  return(fit)
}
```

## 1.2 All zeros
By predicting all outcomes as zeros, the MSE is even better than 2.1 Linear Model, which indicate that a simple linear regression would not work.

## 1.3 Decision tree
```{r}
# input a training data set
# output a fit model
deci_tree <- function(train) {
  tree <- rpart(`281` ~ ., data = train, method = "anova")
  return(tree)
}

```

# 2. Model Evaluation functions

## 2.1 MSE calculation
```{r}
#input a vector of prediction value, the test data set
#output a mse
MSE <- function(prediction, test) {
  mse <- mean((prediction - test$`281`)^2)
  return(mse)
}

```



# 3. Main functions

The Main function calls all other functions above intermittently for the purpose of high efficiency and maintenance, due to high cohesion and low coupling.

## 3.1 Library loading

```{r}
library(readr)
library(glmnet)
library(rpart)
library(rpart.plot)
```

## 3.2 Data loading

The data used here have been pre-processed. I added headers 1-281 for every data set. For the training set, I removed all duplicates, so the total observations come down from 52,397 to 49,203.
```{r}
train_set <- read_csv("data/Processed Data Set/blogData_train duplicate removed.csv")

final_test_set <- read_csv("data/Processed Data Set/blogData_test.csv")

test_set_201 <- read_csv("data/Processed Data Set/blogData_test-2012.02.01.00_00.csv")

test_set_202 <- read_csv("data/Processed Data Set/blogData_test-2012.02.02.00_00.csv")
```
## 3.3 Models running
```{r}
predictions <- predict(deci_tree(train_set), test_set_201 , type = "matrix")

# partial decision tree for output probably >3
train_3plus <- train_set[which(train_set$`281`>3),]
tree3plus <- deci_tree(train_3plus)
id <- c(8,20,25,30,40,71,95,109,111,131,141,155,167)
id <- id + 1
final_test_set3plus <- final_test_set[id,]
predictions <- predict(tree3plus, final_test_set3plus,type = "matrix")


### PCA second try#####################################################################
# Assuming 'data' is your dataframe and 'outcome' is the name of your outcome variable
independent_vars <- train_set_zeroCOLremoved[, !names(train_set_zeroCOLremoved) %in% "281"]
# Scale the independent variables
independent_vars_scaled <- scale(independent_vars)

# Running PCA on the independent variables
pca_result <- prcomp(independent_vars_scaled, scale. = TRUE)

# Summary of PCA
summary(pca_result)

# Scree plot to aid in selecting the number of principal components
plot(pca_result$sdev^2, type = "b", xlab = "Principal Component", ylab = "Variance Explained")

# Selecting the first few principal components based on the scree plot or variance explained
n_components <- 14 # for example, if you decided to keep the first two components
pca_scores <- pca_result$x[, 1:n_components]

# Combine PCA scores with the outcome variable
regression_data <- as.data.frame(cbind(pca_scores, outcome = train_set_zeroCOLremoved$`281`))

# Linear regression with the outcome variable and the first two principal components
lm_result <- lm(outcome ~ ., data = regression_data)
summary(lm_result)
#################################################################################

# Assuming 'new_data' is your new dataset
new_independent_vars <- test_set_202[, names(test_set_202) %in% names(independent_vars)]
# Scale the new data
new_independent_vars_scaled <- scale(new_independent_vars, center = attr(independent_vars_scaled, "scaled:center"), scale = attr(independent_vars_scaled, "scaled:scale"))

# Transform new data with PCA
new_pca_scores <- predict(pca_result, newdata = new_independent_vars_scaled)

# Selecting the same number of principal components
new_pca_scores_selected <- new_pca_scores[, 1:n_components]

# Make predictions
predictions <- predict(lm_result, newdata = data.frame(new_pca_scores_selected))
hist(predictions,100)
MSE(predictions,test_set_202)
```

## 3.4 Model evaluation
```{r}
MSE(predictions,test_set_201)
```

## 3.5 Output-as-a-CSV
```{r}

outputcsv <- data.frame(ID = c(0:213))

#outputcsv$num_comments <- as.vector(prediction, final_test_set , type = "matrix")
outputcsv$num_comments <- as.vector(predictions)


write.csv(outputcsv, "csv_for_submission/031405.csv", row.names = FALSE)

```








